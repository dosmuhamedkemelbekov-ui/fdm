<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Freedom Real Estate | Недвижимость</title>
    <!-- Подключаем Telegram Web App SDK и стили -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <style>
        :root {
            --bg: #0A0E1A;
            --bg-secondary: #0F1624;
            --text: #FFFFFF;
            --text-secondary: #A0AEC0;
            --accent: #22C55E;
            --accent-secondary: #FBBF24;
            --accent-hover: #16A34A;
            --accent-light: rgba(34, 197, 94, 0.1);
            --accent-border: rgba(34, 197, 94, 0.2);
            --glass: rgba(255, 255, 255, 0.03);
            --glass-hover: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.08);
            --success: #22C55E;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-accent: 0 8px 32px rgba(34, 197, 94, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0A0E1A 0%, #0F1624 50%, #0A0E1A 100%);
            background-attachment: fixed;
            color: var(--text);
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.6;
            min-height: 100vh;
        }

        .font-space { 
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass:hover {
            background: var(--glass-hover);
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .accent-gradient {
            background: linear-gradient(135deg, #22C55E 0%, #FBBF24 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-accent);
        }

        .accent-gradient:hover {
            background: linear-gradient(135deg, #16A34A 0%, #F59E0B 100%);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(34, 197, 94, 0.25);
        }

        .accent-gradient:active {
            transform: translateY(0);
        }

        .nav-btn { 
            opacity: 0.5; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 12px;
        }

        .nav-btn:hover {
            opacity: 0.8;
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-btn.active { 
            opacity: 1; 
            color: var(--accent);
            background: var(--accent-light);
        }

        .tab-content { 
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-content.active { 
            display: block; 
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .freedom-card {
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.08) 0%, rgba(15, 22, 36, 0.4) 100%);
            border: 1px solid var(--accent-border);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow: var(--shadow-lg), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .no-scrollbar::-webkit-scrollbar { 
            display: none; 
        }
        
        #registration-screen, #login-screen {
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #0A0E1A 0%, #0F1624 100%);
            z-index: 9999; 
            display: none; 
            flex-direction: column; 
            padding: 40px 24px;
            overflow-y: auto;
        }

        .input-freedom {
            background: rgba(255, 255, 255, 0.04);
            border: 1.5px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px 20px;
            width: 100%;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text);
            font-size: 15px;
            font-weight: 500;
        }

        .input-freedom::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .input-freedom:focus { 
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1), var(--shadow-sm);
            transform: translateY(-1px);
        }

        .input-freedom:hover:not(:focus) {
            border-color: rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.05);
        }

        select.input-freedom {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2322C55E' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }

        button {
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button:active {
            transform: scale(0.98);
        }

        .task-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .task-card:hover {
            transform: translateY(-4px);
        }

        .task-btn {
            background: var(--accent-light);
            border: 1px solid var(--accent-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .task-btn:hover {
            background: rgba(34, 197, 94, 0.15);
            border-color: var(--accent);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        nav {
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        nav button.accent-gradient {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        nav button.accent-gradient:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 40px rgba(34, 197, 94, 0.3);
        }

        .shop-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .shop-item:hover {
            transform: translateY(-6px);
            border-color: rgba(255, 255, 255, 0.15);
        }

        #proof-modal {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        #proof-modal .glass {
            box-shadow: var(--shadow-lg), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        textarea {
            resize: none;
            font-family: inherit;
        }

        header {
            background: linear-gradient(180deg, rgba(10, 14, 26, 0.8) 0%, transparent 100%);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .history-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-item:hover {
            transform: translateX(4px);
            background: var(--glass-hover);
        }

        .leader-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .leader-item:hover {
            transform: translateX(6px);
            background: var(--glass-hover);
        }

        #balance {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #progress {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
        }

        #user-avatar {
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #user-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(34, 197, 94, 0.3);
        }

        #qr-modal {
            position: fixed;
            inset: 0;
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        #qr-modal .glass {
            width: 100%;
            max-width: 420px;
        }

        #qr-video {
            width: 100%;
            aspect-ratio: 3 / 4;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            object-fit: cover;
        }

        .qr-hint {
            border: 1px solid rgba(34, 197, 94, 0.18);
            background: rgba(34, 197, 94, 0.06);
        }
    </style>
</head>
<body class="pb-24">

    <!-- Loader -->
    <div id="loader" class="fixed inset-0 bg-gradient-to-br from-[#0A0E1A] to-[#0F1624] z-[10000] flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-6"></div>
            <p class="text-sm font-bold tracking-widest text-green-400 uppercase">Freedom Real Estate Loading...</p>
        </div>
    </div>

    <!-- Регистрация -->
    <section id="registration-screen" class="justify-center max-w-md mx-auto">
        <div class="mb-12 text-center">
            <h2 class="text-4xl font-extrabold font-space bg-gradient-to-br from-green-400 to-yellow-400 bg-clip-text text-transparent mb-3">Freedom Real Estate</h2>
            <p class="text-gray-400 text-base">Ваш надежный партнер в недвижимости</p>
        </div>
        <div class="space-y-5">
            <input type="text" id="reg-name" class="input-freedom" placeholder="ФИО полностью">
            <input type="text" id="reg-group" class="input-freedom" placeholder="Отдел / Должность">
            <select id="reg-role" class="input-freedom">
                <option value="Риелтор">Риелтор</option>
                <option value="Менеджер по продажам">Менеджер по продажам</option>
                <option value="Менеджер по аренде">Менеджер по аренде</option>
                <option value="Аналитик">Аналитик</option>
                <option value="Маркетолог">Маркетолог</option>
                <option value="Юрист">Юрист</option>
                <option value="Оценщик">Оценщик</option>
                <option value="Фотограф">Фотограф</option>
                <option value="Администратор">Администратор</option>
                <option value="Директор">Директор</option>
            </select>
            <input type="password" id="reg-pass" class="input-freedom" placeholder="Придумайте пароль">
            <button onclick="submitRegistration()" class="w-full py-4 accent-gradient rounded-2xl font-bold text-white uppercase mt-6">Зарегистрироваться</button>
        </div>
    </section>

    <!-- Основное приложение -->
    <div id="main-app" style="display:none">
        <!-- Header -->
        <header class="p-6 pb-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button id="user-avatar" onclick="openProfile()" class="w-14 h-14 rounded-2xl accent-gradient p-[2px] overflow-hidden">
                    <div id="user-avatar-inner" class="bg-[#0A0E1A] w-full h-full rounded-[14px] flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user-tie text-green-400 text-lg"></i>
                    </div>
                </button>
                <div>
                    <h1 id="user-name" class="text-base font-bold tracking-tight">...</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <p id="user-rank" class="text-[11px] font-extrabold text-green-400 uppercase tracking-wider">Новичок</p>
                    </div>
                </div>
            </div>
            <div class="text-right flex items-center gap-3">
                <div class="text-right">
                    <p id="user-role-top" class="text-[11px] font-bold text-gray-300 uppercase tracking-wider">...</p>
                    <p id="user-group" class="text-[10px] font-medium text-green-400/60 uppercase mt-1">...</p>
                </div>
                <button id="admin-open-btn" onclick="openAdmin()" class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 text-gray-300 hover:text-white hover:bg-white/10 transition-colors flex items-center justify-center">
                    <i class="fas fa-shield-halved"></i>
                </button>
            </div>
        </header>

        <main class="px-6">
            <!-- Главная: Баланс -->
            <section id="dashboard" class="tab-content active">
                <div class="freedom-card rounded-3xl p-8 text-center mb-8">
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-[0.15em] mb-5">Ваш баланс баллов</p>
                    <div class="flex justify-center items-baseline gap-3 mb-8">
                        <span id="balance" class="text-7xl font-space font-bold tracking-tighter bg-gradient-to-br from-green-400 to-yellow-400 bg-clip-text text-transparent">0</span>
                        <div class="text-left">
                            <p class="text-green-400 font-bold leading-none text-lg">BP</p>
                            <p class="text-[10px] text-gray-500 uppercase">баллов</p>
                        </div>
                    </div>
                    <div class="w-full h-2.5 bg-white/5 rounded-full overflow-hidden mb-4">
                        <div id="progress" class="h-full accent-gradient rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="level-guide" class="text-[10px] text-gray-400 mt-4 font-semibold">... до звания Профи</p>
                </div>

                <div class="flex justify-between items-center mb-5">
                    <h2 class="text-sm font-bold uppercase tracking-wider text-gray-400">Последние начисления</h2>
                </div>
                <div id="history-list" class="space-y-3">
                    <!-- Сюда придут данные -->
                </div>
            </section>

            <!-- Задания -->
            <section id="earn" class="tab-content">
                <h2 class="text-3xl font-space font-bold mb-8 tracking-tight">Задания</h2>
                <div class="space-y-4">
                    <div class="glass p-6 flex justify-between items-center task-card">
                        <div class="flex-1">
                            <p class="font-bold text-base mb-1">Продажа объекта</p>
                            <p class="text-xs text-gray-400">Закрытая сделка</p>
                        </div>
                        <button onclick="openProofModal('Продажа объекта', 100)" class="task-btn px-5 py-2.5 rounded-xl text-green-400 text-xs font-bold ml-4">+100 BP</button>
                    </div>
                    <div class="glass p-6 flex justify-between items-center task-card">
                        <div class="flex-1">
                            <p class="font-bold text-base mb-1">Аренда объекта</p>
                            <p class="text-xs text-gray-400">Подписан договор</p>
                        </div>
                        <button onclick="openProofModal('Аренда объекта', 50)" class="task-btn px-5 py-2.5 rounded-xl text-green-400 text-xs font-bold ml-4">+50 BP</button>
                    </div>
                    <div class="glass p-6 flex justify-between items-center task-card">
                        <div class="flex-1">
                            <p class="font-bold text-base mb-1">Показ объекта</p>
                            <p class="text-xs text-gray-400">Проведен показ клиенту</p>
                        </div>
                        <button onclick="openProofModal('Показ объекта', 25)" class="task-btn px-5 py-2.5 rounded-xl text-green-400 text-xs font-bold ml-4">+25 BP</button>
                    </div>
                </div>
            </section>

            <!-- Магазин -->
            <section id="shop" class="tab-content">
                <h2 class="text-3xl font-space font-bold mb-8 tracking-tight">Магазин</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass p-5 text-center shop-item">
                        <div class="h-28 bg-gradient-to-br from-green-500/10 to-yellow-500/5 rounded-2xl mb-4 flex items-center justify-center">
                            <i class="fas fa-gift text-3xl text-green-400"></i>
                        </div>
                        <p class="text-xs font-bold uppercase mb-3 tracking-wider">Бонус</p>
                        <button onclick="buyItem('Бонус', 500)" class="w-full py-2.5 accent-gradient rounded-xl text-xs font-bold text-white">500 BP</button>
                    </div>
                    <div class="glass p-5 text-center shop-item">
                        <div class="h-28 bg-gradient-to-br from-green-500/10 to-yellow-500/5 rounded-2xl mb-4 flex items-center justify-center">
                            <i class="fas fa-certificate text-3xl text-green-400"></i>
                        </div>
                        <p class="text-xs font-bold uppercase mb-3 tracking-wider">Сертификат</p>
                        <button onclick="buyItem('Сертификат', 300)" class="w-full py-2.5 accent-gradient rounded-xl text-xs font-bold text-white">300 BP</button>
                    </div>
                </div>
            </section>

            <!-- Рейтинг -->
            <section id="rating" class="tab-content">
                <h2 class="text-3xl font-space font-bold mb-8 tracking-tight">Лидеры</h2>
                <div id="leaderboard-list" class="space-y-4">
                    <!-- Сюда придут лидеры -->
                </div>
            </section>

            <!-- Admin -->
            <section id="admin" class="tab-content">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-space font-bold tracking-tight">Admin</h2>
                        <p class="text-sm text-gray-400 mt-1">Модерация заявок и начислений.</p>
                    </div>
                    <button onclick="showTab('dashboard')" class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-sm font-bold text-gray-200 hover:bg-white/10 transition-colors">
                        Назад
                    </button>
                </div>

                <div class="glass p-6 mb-6">
                    <div class="flex items-center justify-between gap-4">
                        <div class="min-w-0">
                            <p class="text-xs uppercase tracking-wider text-gray-400 font-bold">Статус</p>
                            <p id="admin-status" class="text-sm text-gray-300 mt-1">Не авторизован</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="adminRefresh()" class="px-4 py-2 rounded-xl accent-gradient text-sm font-bold text-white">
                                Обновить
                            </button>
                            <button onclick="adminLogout()" class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-sm font-bold text-gray-200 hover:bg-white/10 transition-colors">
                                Выйти
                            </button>
                        </div>
                    </div>
                </div>

                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Заявки на баллы (pending)</h3>
                <div id="admin-proofs" class="space-y-4"></div>

                <div class="h-8"></div>

                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Начисление вручную</h3>
                <div class="glass p-6">
                    <div class="space-y-4">
                        <input id="admin-user-id" class="input-freedom" placeholder="User ID (Telegram)">
                        <input id="admin-action" class="input-freedom" placeholder="За что (например: Бонус)">
                        <input id="admin-amount" class="input-freedom" placeholder="Сколько BP (например: 25)" inputmode="numeric">
                        <button onclick="adminAdjust()" class="w-full py-3 accent-gradient rounded-2xl font-bold text-white">
                            Начислить
                        </button>
                    </div>
                </div>

                <div class="h-8"></div>

                <h3 class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-4">Смена пароля</h3>
                <div class="glass p-6">
                    <div class="space-y-4">
                        <input id="admin-old-pass" class="input-freedom" placeholder="Текущий пароль" type="password">
                        <input id="admin-new-pass" class="input-freedom" placeholder="Новый пароль" type="password">
                        <button onclick="adminChangePassword()" class="w-full py-3 bg-white/5 border border-white/10 rounded-2xl font-bold text-gray-200 hover:bg-white/10 transition-colors">
                            Обновить пароль
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Navbar -->
        <nav class="fixed bottom-6 left-6 right-6 glass p-4 flex justify-around items-center z-50">
            <button onclick="showTab('dashboard')" class="nav-btn active flex-1 flex flex-col items-center gap-1">
                <i class="fas fa-home text-xl"></i>
            </button>
            <button onclick="showTab('earn')" class="nav-btn flex-1 flex flex-col items-center gap-1">
                <i class="fas fa-tasks text-xl"></i>
            </button>
            <div class="flex-1 flex justify-center -mt-14">
                <button onclick="startScan()" class="w-16 h-16 accent-gradient rounded-full flex items-center justify-center text-white">
                    <i class="fas fa-qrcode text-2xl"></i>
                </button>
            </div>
            <button onclick="showTab('shop')" class="nav-btn flex-1 flex flex-col items-center gap-1">
                <i class="fas fa-shopping-bag text-xl"></i>
            </button>
            <button onclick="showTab('rating')" class="nav-btn flex-1 flex flex-col items-center gap-1">
                <i class="fas fa-trophy text-xl"></i>
            </button>
        </nav>
    </div>

    <!-- QR Scanner (browser fallback) -->
    <div id="qr-modal">
        <div class="glass p-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <h3 class="font-space text-lg font-bold tracking-tight text-green-400">Сканирование QR</h3>
                    <p class="text-sm text-gray-400 mt-1">Наведи камеру на код.</p>
                </div>
                <button id="qr-close-btn" class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 text-gray-300 hover:text-white hover:bg-white/10 transition-colors flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="relative">
                <video id="qr-video" playsinline muted></video>
            </div>

            <div class="qr-hint rounded-2xl p-4 mt-4 text-sm text-gray-200">
                Если камера не открылась — проверь разрешения для камеры в браузере.
            </div>
        </div>
    </div>

    <!-- Модалка отчета -->
    <div id="proof-modal" class="fixed inset-0 bg-black/80 z-[10001] hidden flex items-center justify-center p-6">
        <div class="glass p-8 w-full max-w-sm">
            <h3 class="font-space text-xl font-bold text-green-400 mb-2 tracking-tight">Подтверждение</h3>
            <p id="modal-task-name" class="text-sm text-gray-400 mb-6">Название задачи</p>
            <textarea id="proof-input" class="input-freedom w-full h-32 mb-6" placeholder="Вставьте ссылку на фото/документ или описание выполненной работы..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeProofModal()" class="flex-1 py-3 rounded-xl text-sm font-bold text-gray-400 hover:text-white transition-colors">Отмена</button>
                <button onclick="submitTaskWithProof()" class="flex-1 py-3 accent-gradient rounded-xl text-sm font-bold text-white">Отправить</button>
            </div>
        </div>
    </div>

    <!-- Профиль пользователя -->
    <section id="profile-screen" class="fixed inset-0 bg-black/80 z-[10002] hidden flex items-center justify-center p-6">
        <div class="glass p-7 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="font-space text-2xl font-bold tracking-tight" id="profile-title">Личный кабинет</h2>
                    <p class="text-sm text-gray-400 mt-1" id="profile-subtitle">Аватар, язык, фон и пароль.</p>
                </div>
                <button onclick="closeProfile()" class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 text-gray-300 hover:text-white hover:bg-white/10 transition-colors flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex flex-col items-center mb-6">
                <div class="w-20 h-20 rounded-3xl accent-gradient p-[2px] mb-3">
                    <div class="bg-[#0A0E1A] w-full h-full rounded-[22px] flex items-center justify-center overflow-hidden">
                        <img id="profile-avatar-preview" src="" alt="avatar" class="hidden w-full h-full object-cover rounded-[22px]">
                        <i id="profile-avatar-icon" class="fas fa-user-tie text-green-400 text-2xl"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 text-center" id="profile-avatar-hint">Вставь ссылку на изображение (JPEG/PNG/WebP).</p>
            </div>

            <div class="space-y-5">
                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-2" id="profile-avatar-label">Ссылка на аватар</p>
                    <input id="profile-avatar-url" class="input-freedom" placeholder="https://...">
                </div>

                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-3" id="profile-lang-label">Язык интерфейса</p>
                    <div class="flex gap-2">
                        <button type="button" class="flex-1 py-2 rounded-xl bg-white/5 border border-white/10 text-sm font-semibold text-gray-200 hover:bg-white/10 transition-colors profile-lang-btn" data-lang="kz">Қаз</button>
                        <button type="button" class="flex-1 py-2 rounded-xl bg-white/5 border border-white/10 text-sm font-semibold text-gray-200 hover:bg-white/10 transition-colors profile-lang-btn" data-lang="ru">Рус</button>
                        <button type="button" class="flex-1 py-2 rounded-xl bg-white/5 border border-white/10 text-sm font-semibold text-gray-200 hover:bg-white/10 transition-colors profile-lang-btn" data-lang="en">Eng</button>
                    </div>
                </div>

                <div>
                    <p class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-3" id="profile-theme-label">Фон приложения</p>
                    <div class="flex gap-2">
                        <button type="button" class="flex-1 py-2 rounded-xl bg-gradient-to-r from-green-600/40 to-yellow-600/40 border border-green-500/40 text-xs font-semibold text-gray-100 profile-theme-btn" data-theme="default">Default</button>
                        <button type="button" class="flex-1 py-2 rounded-xl bg-gradient-to-r from-purple-600/40 to-fuchsia-600/40 border border-purple-500/40 text-xs font-semibold text-gray-100 profile-theme-btn" data-theme="purple">Neon</button>
                        <button type="button" class="flex-1 py-2 rounded-xl bg-gradient-to-r from-orange-500/40 to-pink-500/40 border border-orange-400/40 text-xs font-semibold text-gray-100 profile-theme-btn" data-theme="sunset">Sunset</button>
                    </div>
                </div>

                <button onclick="saveProfile()" class="w-full py-3 accent-gradient rounded-2xl font-bold text-white text-sm">
                    Сохранить настройки
                </button>

                <div class="pt-4 border-t border-white/5 mt-2">
                    <p class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-3" id="profile-pass-label">Смена пароля</p>
                    <div class="space-y-3">
                        <input id="profile-old-pass" class="input-freedom" placeholder="Текущий пароль" type="password">
                        <input id="profile-new-pass" class="input-freedom" placeholder="Новый пароль" type="password">
                        <button onclick="changeUserPassword()" class="w-full py-3 bg-white/5 border border-white/10 rounded-2xl font-bold text-gray-200 hover:bg-white/10 transition-colors text-sm">
                            Обновить пароль
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Admin Login -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black/80 z-[10003] hidden flex items-center justify-center p-6">
        <div class="glass p-8 w-full max-w-sm">
            <h3 class="font-space text-xl font-bold text-green-400 mb-2 tracking-tight">Вход в Admin</h3>
            <p class="text-sm text-gray-400 mb-6">Введите логин и пароль администратора.</p>
            <div class="space-y-4">
                <input id="admin-login" class="input-freedom" placeholder="Логин" autocomplete="username">
                <input id="admin-password" class="input-freedom" placeholder="Пароль" type="password" autocomplete="current-password">
                <button onclick="adminLogin()" class="w-full py-3 accent-gradient rounded-2xl font-bold text-white">
                    Войти
                </button>
                <button onclick="closeAdminLogin()" class="w-full py-3 rounded-2xl bg-white/5 border border-white/10 font-bold text-gray-200 hover:bg-white/10 transition-colors">
                    Отмена
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) tg.expand();
        
        // ЗАМЕНИ НА СВОЙ API URL (Google Apps Script Web App)
        const API_URL = "https://script.google.com/macros/s/AKfycbzhPwy1rbWC3lLcoCuvwGwHk6zhYYmr_yfWwNGOwJ9jL5n4n8IW2Nt1_cDNUY3RSdp6/exec"; 
        
        let userLocal = {};
        let currentTask = {};
        let qrStream = null;
        let qrRaf = null;
        let adminToken = localStorage.getItem("freedom_admin_token") || "";
        let adminLoginName = localStorage.getItem("freedom_admin_login") || "";

        function getUserId() {
            return tg?.initDataUnsafe?.user?.id || "12345678";
        }

        async function apiRequest(action, params = {}, options = {}) {
            const method = options.method || "GET";
            let res;

            if (method === "POST") {
                const body = new URLSearchParams({ action, ...params }).toString();
                res = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                    body,
                });
            } else {
                const qs = new URLSearchParams({ action, ...params }).toString();
                res = await fetch(`${API_URL}?${qs}`);
            }

            if (!res.ok) {
                const text = await res.text().catch(() => "");
                throw new Error(`API ${res.status}: ${text || res.statusText}`);
            }
            return await res.json();
        }

        async function syncData() {
            const userId = getUserId();
            
            try {
                const data = await apiRequest("getUser", { id: String(userId) }, { method: "GET" });
                
                if (!data.registered) {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('registration-screen').style.display = 'flex';
                } else {
                    userLocal = data;
                    userLocal.id = userId;
                    renderApp(data);
                    document.getElementById('loader').style.display = 'none';
                }
            } catch (e) {
                console.error("Ошибка загрузки:", e);
                setTimeout(() => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('registration-screen').style.display = 'flex';
                }, 1500);
            }
        }

        async function submitRegistration() {
            const name = document.getElementById('reg-name').value;
            const group = document.getElementById('reg-group').value;
            const role = document.getElementById('reg-role').value;
            const pass = document.getElementById('reg-pass').value;

            if(!name || !group || !pass) return alert("Пожалуйста, заполни все поля!");

            document.getElementById('loader').style.display = 'flex';
            
            try {
                const userId = getUserId();
                await apiRequest(
                    "register",
                    { id: String(userId), name, group, unit: role, password: pass },
                    { method: "POST" }
                );
                await syncData();
            } catch (e) {
                userLocal = { name, group, unit: role, balance: 0, history: [] };
                renderApp(userLocal);
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderApp(data) {
            document.getElementById('registration-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            document.getElementById('user-name').innerText = data.name;
            document.getElementById('user-group').innerText = data.group;
            document.getElementById('user-role-top').innerText = (data.unit || "Роль").toString();
            document.getElementById('balance').innerText = data.balance || 0;

            window.__isAdmin = !!adminToken;
            updateAdminStatus();
            applyUserPreferences(data);
            
            let rank = "Новичок", next = 100, progress = (data.balance % 100);
            if(data.balance >= 1000) { rank = "Эксперт"; next = 0; progress = 100; }
            else if(data.balance >= 500) { rank = "Профи"; next = 1000; progress = ((data.balance-500)/500)*100; }
            else if(data.balance >= 300) { rank = "Специалист"; next = 500; progress = ((data.balance-300)/200)*100; }
            else if(data.balance >= 100) { rank = "Опытный"; next = 300; progress = ((data.balance-100)/200)*100; }
            
            document.getElementById('user-rank').innerText = rank;
            document.getElementById('progress').style.width = progress + '%';
            document.getElementById('level-guide').innerText = next === 0 ? "Максимальный уровень" : `До звания ${getRankName(next)} еще ${next - data.balance} BP`;

            const historyList = document.getElementById('history-list');
            historyList.innerHTML = (data.history || []).map(h => `
                <div class="glass p-5 flex justify-between items-center history-item">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500/20 to-yellow-500/10 flex items-center justify-center border border-green-500/20">
                            <i class="fas fa-check text-xs text-green-400"></i>
                        </div>
                        <p class="text-sm font-bold">${h.action}</p>
                    </div>
                    <p class="text-sm font-black text-green-400">+${h.amount} BP</p>
                </div>
            `).join('');
        }

        function getRankName(pts) {
            if(pts === 300) return "Опытный";
            if(pts === 500) return "Специалист";
            if(pts === 1000) return "Профи";
            return "Эксперт";
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            try {
                if (typeof event !== 'undefined' && event && event.currentTarget) event.currentTarget.classList.add('active');
            } catch (_) {}
            
            if(id === 'rating') loadLeaderboard();
        }

        function openProofModal(name, amount) {
            currentTask = { name, amount };
            document.getElementById('modal-task-name').innerText = name + " (" + amount + " BP)";
            document.getElementById('proof-modal').style.display = 'flex';
        }

        function closeProofModal() { document.getElementById('proof-modal').style.display = 'none'; }

        async function submitTaskWithProof() {
            const proof = document.getElementById('proof-input').value;
            if(!proof) return alert("Пожалуйста, предоставь доказательства!");
            
            try {
                const userId = getUserId();
                await apiRequest(
                    "submitProof",
                    {
                        id: String(userId),
                        taskName: currentTask?.name || "",
                        amount: String(currentTask?.amount || 0),
                        proof,
                    },
                    { method: "POST" }
                );
                alert("Ваш отчет отправлен на проверку!");
                closeProofModal();
                document.getElementById('proof-input').value = "";
            } catch (e) {
                console.error(e);
                alert("Не удалось отправить отчет. Попробуй позже.");
            }
        }

        async function buyItem(name, price) {
            if (userLocal.balance < price) return alert("Недостаточно баллов!");
            if (confirm(`Купить ${name} за ${price} BP?`)) {
                alert("Заявка на покупку отправлена!");
            }
        }

        function startScan() {
            if (tg?.showScanQrPopup) {
                tg.showScanQrPopup({ text: "Сканируй код" }, async function(text) {
                    try {
                        await handleQrCode(text);
                    } finally {
                        tg.closeScanQrPopup();
                    }
                });
                return;
            }
            openBrowserQrScanner();
        }

        async function handleQrCode(text) {
            const code = String(text || "").trim();
            if (!code) return;

            try {
                const userId = getUserId();
                const data = await apiRequest(
                    "redeemQr",
                    { id: String(userId), code },
                    { method: "POST" }
                );

                if (data?.ok && data?.user) {
                    userLocal = data.user;
                    userLocal.id = userId;
                    renderApp(userLocal);
                    alert(data.message || "Код принят!");
                } else {
                    alert(data?.message || ("Код принят: " + code));
                }
            } catch (e) {
                console.error(e);
                alert("Не удалось обработать QR. Проверь интернет или API.");
            }
        }

        async function openBrowserQrScanner() {
            const modal = document.getElementById("qr-modal");
            const video = document.getElementById("qr-video");

            modal.style.display = "flex";

            try {
                qrStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: { ideal: "environment" } },
                    audio: false,
                });
                video.srcObject = qrStream;
                await video.play();
                startQrLoop();
            } catch (e) {
                console.error(e);
                alert("Нет доступа к камере. Разреши камеру в браузере.");
                closeBrowserQrScanner();
            }
        }

        function closeBrowserQrScanner() {
            const modal = document.getElementById("qr-modal");
            const video = document.getElementById("qr-video");

            if (qrRaf) cancelAnimationFrame(qrRaf);
            qrRaf = null;

            if (qrStream) {
                qrStream.getTracks().forEach(t => t.stop());
                qrStream = null;
            }

            if (video) {
                video.pause?.();
                video.srcObject = null;
            }

            if (modal) modal.style.display = "none";
        }

        function startQrLoop() {
            const video = document.getElementById("qr-video");
            if (!video) return;

            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d", { willReadFrequently: true });

            const tick = async () => {
                if (!video.srcObject) return;

                const w = video.videoWidth || 0;
                const h = video.videoHeight || 0;
                if (w > 0 && h > 0) {
                    canvas.width = w;
                    canvas.height = h;
                    ctx.drawImage(video, 0, 0, w, h);
                    const imageData = ctx.getImageData(0, 0, w, h);
                    const qr = window.jsQR?.(imageData.data, w, h);
                    if (qr?.data) {
                        closeBrowserQrScanner();
                        await handleQrCode(qr.data);
                        return;
                    }
                }

                qrRaf = requestAnimationFrame(tick);
            };

            qrRaf = requestAnimationFrame(tick);
        }

        async function loadLeaderboard() {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = `<div class="text-center p-10"><div class="loader mx-auto"></div></div>`;
            
            let leaders = [];
            try {
                const data = await apiRequest("getLeaderboard", {}, { method: "GET" });
                leaders = data?.leaders || [];
            } catch (e) {
                console.error(e);
                leaders = [
                    {name: "Алексей Иванов", unit: "Риелтор", balance: 1250},
                    {name: "Мария Петрова", unit: "Менеджер", balance: 980},
                    {name: "Дмитрий Сидоров", unit: "Аналитик", balance: 740}
                ];
            }

            list.innerHTML = leaders.map((u, i) => `
                <div class="glass p-5 flex justify-between items-center leader-item">
                    <div class="flex items-center gap-4">
                        <span class="text-lg font-black opacity-30 font-space">0${i+1}</span>
                        <div>
                            <p class="text-base font-bold">${u.name}</p>
                            <p class="text-xs uppercase text-green-400/70 tracking-wider mt-0.5">${u.unit || ""}</p>
                        </div>
                    </div>
                    <p class="font-space font-bold text-lg text-green-400">${u.balance} BP</p>
                </div>
            `).join('');
        }

        function openAdmin() {
            if (!adminToken) {
                openAdminLogin();
                return;
            }
            showTab("admin");
            updateAdminStatus();
            adminRefresh();
        }

        async function adminRefresh() {
            if (!adminToken) {
                openAdminLogin();
                return;
            }
            const box = document.getElementById("admin-proofs");
            if (!box) return;

            box.innerHTML = `<div class="text-center p-10"><div class="loader mx-auto"></div></div>`;

            try {
                const data = await apiRequest("adminListProofs", { token: adminToken }, { method: "GET" });
                if (!data?.ok && (data?.message === "Unauthorized" || data?.message === "Forbidden")) {
                    adminToken = "";
                    localStorage.removeItem("freedom_admin_token");
                    updateAdminStatus();
                    openAdminLogin();
                    return;
                }
                const items = data?.items || [];

                if (!items.length) {
                    box.innerHTML = `<div class="glass p-6 text-center text-gray-400">Нет заявок на модерации.</div>`;
                    return;
                }

                box.innerHTML = items.map(item => `
                    <div class="glass p-6">
                        <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0">
                                <p class="text-base font-bold truncate">${escapeHtml_(item.userName || item.userId || "")}</p>
                                <p class="text-xs text-gray-400 mt-1">${escapeHtml_(item.role || "")} • ${escapeHtml_(item.group || "")}</p>
                                <p class="text-sm text-gray-200 mt-4">${escapeHtml_(item.taskName || "")}</p>
                                <p class="text-sm font-black text-green-400 mt-2">+${Number(item.amount || 0)} BP</p>
                                <a href="${escapeAttr_(item.proof || "#")}" target="_blank" class="inline-block mt-3 text-sm text-green-300 hover:text-green-200 underline underline-offset-4 break-all">
                                    ${escapeHtml_(item.proof || "")}
                                </a>
                                <p class="text-xs text-gray-500 mt-3">${escapeHtml_(item.ts || "")}</p>
                            </div>
                            <div class="flex flex-col gap-3 shrink-0">
                                <button onclick="adminDecide(${Number(item.row)}, 'approve')" class="px-4 py-2 rounded-xl accent-gradient text-sm font-bold text-white">Одобрить</button>
                                <button onclick="adminDecide(${Number(item.row)}, 'reject')" class="px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-sm font-bold text-gray-200 hover:bg-white/10 transition-colors">Отклонить</button>
                            </div>
                        </div>
                    </div>
                `).join("");
            } catch (e) {
                console.error(e);
                box.innerHTML = `<div class="glass p-6 text-center text-gray-400">Ошибка загрузки заявок.</div>`;
            }
        }

        async function adminDecide(row, decision) {
            if (!adminToken) {
                openAdminLogin();
                return;
            }
            const ok = confirm(decision === "approve" ? "Одобрить и начислить?" : "Отклонить заявку?");
            if (!ok) return;

            try {
                const data = await apiRequest(
                    "adminDecideProof",
                    { token: adminToken, row: String(row), decision: String(decision) },
                    { method: "POST" }
                );
                if (!data?.ok) {
                    if (data?.message === "Unauthorized" || data?.message === "Forbidden") {
                        adminToken = "";
                        localStorage.removeItem("freedom_admin_token");
                        updateAdminStatus();
                        openAdminLogin();
                        return;
                    }
                    alert(data?.message || "Ошибка");
                    return;
                }
                await syncData();
                await adminRefresh();
            } catch (e) {
                console.error(e);
                alert("Не удалось выполнить действие.");
            }
        }

        async function adminAdjust() {
            if (!adminToken) {
                openAdminLogin();
                return;
            }
            const userId = String(document.getElementById("admin-user-id")?.value || "").trim();
            const action = String(document.getElementById("admin-action")?.value || "").trim();
            const amount = String(document.getElementById("admin-amount")?.value || "").trim();
            if (!userId || !action || !amount) {
                alert("Заполни все поля.");
                return;
            }

            try {
                const data = await apiRequest(
                    "adminAdjustBalance",
                    { token: adminToken, userId, action, amount },
                    { method: "POST" }
                );
                if (!data?.ok) {
                    if (data?.message === "Unauthorized" || data?.message === "Forbidden") {
                        adminToken = "";
                        localStorage.removeItem("freedom_admin_token");
                        updateAdminStatus();
                        openAdminLogin();
                        return;
                    }
                    alert(data?.message || "Ошибка");
                    return;
                }
                alert("Готово.");
                document.getElementById("admin-user-id").value = "";
                document.getElementById("admin-action").value = "";
                document.getElementById("admin-amount").value = "";
            } catch (e) {
                console.error(e);
                alert("Не удалось начислить.");
            }
        }

        function escapeHtml_(s) {
            return String(s || "")
                .replaceAll("&", "&amp;")
                .replaceAll("<", "&lt;")
                .replaceAll(">", "&gt;")
                .replaceAll('"', "&quot;")
                .replaceAll("'", "&#39;");
        }

        function escapeAttr_(s) {
            return escapeHtml_(s).replaceAll("`", "&#96;");
        }

        function updateAdminStatus() {
            const el = document.getElementById("admin-status");
            if (!el) return;
            el.innerText = adminToken
                ? ("Авторизован как " + (adminLoginName || "admin"))
                : "Не авторизован";
        }

        function openAdminLogin() {
            document.getElementById("admin-login-modal").style.display = "flex";
            document.getElementById("admin-password").value = "";
            updateAdminStatus();
        }

        function closeAdminLogin() {
            document.getElementById("admin-login-modal").style.display = "none";
        }

        async function adminLogin() {
            const login = String(document.getElementById("admin-login")?.value || "").trim();
            const password = String(document.getElementById("admin-password")?.value || "");
            if (!login || !password) {
                alert("Введите логин и пароль.");
                return;
            }

            try {
                const data = await apiRequest("adminLogin", { login, password }, { method: "POST" });
                if (!data?.ok) {
                    alert(data?.message || "Ошибка входа");
                    return;
                }
                adminToken = String(data.token || "");
                adminLoginName = String(data.login || login);
                localStorage.setItem("freedom_admin_token", adminToken);
                localStorage.setItem("freedom_admin_login", adminLoginName);
                updateAdminStatus();
                closeAdminLogin();
                openAdmin();
            } catch (e) {
                console.error(e);
                alert("Не удалось войти. Проверь API.");
            }
        }

        function adminLogout() {
            adminToken = "";
            adminLoginName = "";
            localStorage.removeItem("freedom_admin_token");
            localStorage.removeItem("freedom_admin_login");
            updateAdminStatus();
            showTab("dashboard");
        }

        async function adminChangePassword() {
            if (!adminToken) {
                openAdminLogin();
                return;
            }
            const oldPassword = String(document.getElementById("admin-old-pass")?.value || "");
            const newPassword = String(document.getElementById("admin-new-pass")?.value || "");
            if (!oldPassword || !newPassword) {
                alert("Заполни оба поля.");
                return;
            }
            try {
                const data = await apiRequest(
                    "adminChangePassword",
                    { token: adminToken, oldPassword, newPassword },
                    { method: "POST" }
                );
                if (!data?.ok) {
                    if (data?.message === "Unauthorized" || data?.message === "Forbidden") {
                        adminToken = "";
                        adminLoginName = "";
                        localStorage.removeItem("freedom_admin_token");
                        localStorage.removeItem("freedom_admin_login");
                        updateAdminStatus();
                        openAdminLogin();
                        return;
                    }
                    alert(data?.message || "Не удалось сменить пароль");
                    return;
                }
                alert("Пароль обновлён.");
                document.getElementById("admin-old-pass").value = "";
                document.getElementById("admin-new-pass").value = "";
            } catch (e) {
                console.error(e);
                alert("Ошибка при смене пароля.");
            }
        }

        let profileLang = "ru";
        let profileTheme = "default";

        function applyUserPreferences(data) {
            profileLang = data.lang || "ru";
            profileTheme = data.theme || "default";

            applyTheme(profileTheme);
            applyLanguage(profileLang);
            updateAvatar(data.avatar || "");
        }

        function applyTheme(theme) {
            const body = document.body;
            body.classList.remove("theme-default", "theme-purple", "theme-sunset");
            if (theme === "purple") body.classList.add("theme-purple");
            else if (theme === "sunset") body.classList.add("theme-sunset");
            else body.classList.add("theme-default");
        }

        const I18N = {
            ru: {
                profileTitle: "Личный кабинет",
                profileSubtitle: "Аватар, язык, фон и пароль.",
                avatarHint: "Вставь ссылку на изображение (JPEG/PNG/WebP).",
                avatarLabel: "Ссылка на аватар",
                langLabel: "Язык интерфейса",
                themeLabel: "Фон приложения",
                passLabel: "Смена пароля",
            },
            kz: {
                profileTitle: "Жеке кабинет",
                profileSubtitle: "Аватар, тіл, фон және құпиясөз.",
                avatarHint: "Сурет сілтемесін енгізіңіз (JPEG/PNG/WebP).",
                avatarLabel: "Аватар сілтемесі",
                langLabel: "Интерфейс тілі",
                themeLabel: "Қолданба фоны",
                passLabel: "Құпиясөзді өзгерту",
            },
            en: {
                profileTitle: "Profile",
                profileSubtitle: "Avatar, language, background and password.",
                avatarHint: "Paste image URL (JPEG/PNG/WebP).",
                avatarLabel: "Avatar URL",
                langLabel: "Interface language",
                themeLabel: "App background",
                passLabel: "Change password",
            }
        };

        function applyLanguage(lang) {
            const dict = I18N[lang] || I18N.ru;
            profileLang = lang;
            const m = {
                "profile-title": "profileTitle",
                "profile-subtitle": "profileSubtitle",
                "profile-avatar-hint": "avatarHint",
                "profile-avatar-label": "avatarLabel",
                "profile-lang-label": "langLabel",
                "profile-theme-label": "themeLabel",
                "profile-pass-label": "passLabel",
            };
            Object.keys(m).forEach(id => {
                const el = document.getElementById(id);
                if (el && dict[m[id]]) el.innerText = dict[m[id]];
            });

            document.querySelectorAll(".profile-lang-btn").forEach(btn => {
                const code = btn.getAttribute("data-lang");
                if (code === lang) {
                    btn.classList.add("bg-green-500/20", "border-green-400", "text-green-200");
                } else {
                    btn.classList.remove("bg-green-500/20", "border-green-400", "text-green-200");
                }
            });
        }

        function updateAvatar(url) {
            const img = document.getElementById("profile-avatar-preview");
            const icon = document.getElementById("profile-avatar-icon");
            const headerInner = document.getElementById("user-avatar-inner");
            if (!img || !icon || !headerInner) return;

            if (url) {
                img.src = url;
                img.classList.remove("hidden");
                icon.classList.add("hidden");
                headerInner.innerHTML = `<img src="${escapeAttr_(url)}" alt="avatar" class="w-full h-full object-cover rounded-[14px]">`;
            } else {
                img.classList.add("hidden");
                icon.classList.remove("hidden");
                headerInner.innerHTML = `<i class="fas fa-user-tie text-green-400 text-lg"></i>`;
            }
        }

        function openProfile() {
            document.getElementById("profile-screen").style.display = "flex";
            document.getElementById("profile-avatar-url").value = userLocal.avatar || "";
            document.getElementById("profile-old-pass").value = "";
            document.getElementById("profile-new-pass").value = "";

            applyLanguage(userLocal.lang || "ru");
            applyTheme(userLocal.theme || "default");
            updateAvatar(userLocal.avatar || "");

            const theme = userLocal.theme || "default";
            document.querySelectorAll(".profile-theme-btn").forEach(btn => {
                const t = btn.getAttribute("data-theme");
                if (t === theme) {
                    btn.classList.add("ring-2", "ring-green-400/60");
                } else {
                    btn.classList.remove("ring-2", "ring-green-400/60");
                }
            });
        }

        function closeProfile() {
            document.getElementById("profile-screen").style.display = "none";
        }

        document.querySelectorAll(".profile-lang-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const lang = btn.getAttribute("data-lang");
                applyLanguage(lang);
            });
        });

        document.querySelectorAll(".profile-theme-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                const theme = btn.getAttribute("data-theme");
                profileTheme = theme;
                applyTheme(theme);
                document.querySelectorAll(".profile-theme-btn").forEach(b => b.classList.remove("ring-2", "ring-green-400/60"));
                btn.classList.add("ring-2", "ring-green-400/60");
            });
        });

        async function saveProfile() {
            try {
                const avatar = String(document.getElementById("profile-avatar-url")?.value || "").trim();
                const data = await apiRequest(
                    "updateProfile",
                    {
                        id: String(getUserId()),
                        avatar,
                        lang: profileLang,
                        theme: profileTheme,
                    },
                    { method: "POST" }
                );
                if (!data?.ok) {
                    alert(data?.message || "Не удалось сохранить профиль");
                    return;
                }
                userLocal = data.user || userLocal;
                applyUserPreferences(userLocal);
                closeProfile();
            } catch (e) {
                console.error(e);
                alert("Ошибка при сохранении профиля.");
            }
        }

        async function changeUserPassword() {
            const oldPass = String(document.getElementById("profile-old-pass")?.value || "");
            const newPass = String(document.getElementById("profile-new-pass")?.value || "");
            if (!oldPass || !newPass) {
                alert("Заполни оба поля.");
                return;
            }
            try {
                const data = await apiRequest(
                    "changePasswordUser",
                    {
                        id: String(getUserId()),
                        oldPassword: oldPass,
                        newPassword: newPass,
                    },
                    { method: "POST" }
                );
                if (!data?.ok) {
                    alert(data?.message || "Не удалось сменить пароль");
                    return;
                }
                alert("Пароль обновлён.");
                document.getElementById("profile-old-pass").value = "";
                document.getElementById("profile-new-pass").value = "";
            } catch (e) {
                console.error(e);
                alert("Ошибка при смене пароля.");
            }
        }

        document.getElementById("qr-close-btn")?.addEventListener("click", closeBrowserQrScanner);
        document.getElementById("qr-modal")?.addEventListener("click", (e) => {
            if (e.target && e.target.id === "qr-modal") closeBrowserQrScanner();
        });

        syncData();
    </script>
</body>
</html>
